int   LlamaCAAAREM (char *EnviaTrama20,  int  EnviaTramanl, char *EnviArchivo,
                    char *RecibeTrama, short olEsNoPedimento)
{
  int    sockfd_CAAAREM;
  int    hacuse1 = 0, hacuse2 = 0, nacuse1 = 0,  nacuse2 = 0;
  int   *leidos_CAAAREM;
  struct sockaddr_in serv_addr_CAAAREM;
  int    EnviaTramanlhtonl, result;
  char **pptr;
  const char *ptr;
  struct hostent *hptr;
  char str[INET_ADDRSTRLEN], cadenaEnvio[68];
  int  EnviosI = 1;
  char xnumero[8];
  char xinvertido[8];
  char byte1[2];
  char byte2[2];
  char byte3[2];
  char byte4[2];
  char nombreArchivo[13];
  char *varborradachar, *charEnviosI, *ptrbloque = NULL;
  char strPreval[4];
  int  numPreval;
  char strDireccion[16];

#ifndef _200814200_1
  const char *cintesis= "180.176.50.244";	/** 04 **/
  const char *caaarem = "180.176.50.246";	/** 10 **/
  const char *cnime   = "180.176.50.243";	/** 11 **/
  const char *courier = "180.176.50.245";	/** 39 **/
#endif
#ifdef __AMX_07_00087_0A_1
	int   iIndAlterno=1;
#endif
/*  const char caaarem = "180.176.50.242"; */

#ifdef __DEBUG_1
  fprintf(fptr1,"LlamaCAAAREM(%s,%d,%s,%s)\n"
               ,EnviaTrama20,EnviaTramanl,EnviArchivo,RecibeTrama);
  fflush(fptr1);
#endif

  memset(cadenaEnvio,'\0',sizeof(cadenaEnvio));

  leidos_CAAAREM = (int *)malloc(1);
  charEnviosI    = (char *)malloc(3);
  varborradachar = (char *)malloc(3);

  bzero((char *) &serv_addr_CAAAREM, sizeof(serv_addr_CAAAREM));

  fprintf(fptr1,"\n EnviaTrama20 <%s>,  int  EnviaTramanl <%d>, \n EnviArchivo <%s>,\n   RecibeTrama <%s>",
                               EnviaTrama20,  EnviaTramanl,
                               EnviArchivo,   RecibeTrama);

  snprintf(strPreval, 4, "%s", EnviaTrama20 + 17);
  strPreval[3] = '\0';
  fprintf(fptr1,"[LlamaCAAAREM] Prevalidador a validar <%s>\n", strPreval);
  numPreval = atoi((char *) strPreval);
#ifdef _200814200_1
  if( !(serv_tcp_caaarem=buscaPrevalidadoresCNF(numPreval,strDireccion)) )
  {
    iIndAlterno=1;
    fprintf(fptr1,"[LlamaCAAAREM] Error 1: No es posible resolver paquetes para el Prevalidador=%d Puerto=%d HOST[%s] Alterno=%d\n"
                 ,numPreval,serv_tcp_caaarem,strDireccion,iIndAlterno);
    fflush(fptr1);
    renombrarArchivoS(EnviaTrama20,fptr1);
    return 1;
  }
  fprintf(fptr1, " SERV_TCP_CAAAREM <%d>\n", serv_tcp_caaarem);
#else
  switch(numPreval)
  {
	  case 4:		/** CINTESIS **/
			sprintf(strDireccion, "%s", cintesis);	break;
	  case 10:		/** CAAAREM  **/
			sprintf(strDireccion, "%s", caaarem);	break;
	  case 11:		/**  CNIME   **/
			sprintf(strDireccion, "%s", cnime);		break;
	  case 39:		/** COURIER  **/
			sprintf(strDireccion, "%s", courier);	break;
	  default:
  		        fprintf(fptr1,"[Error] No es posible resolver paquetes para el Prevalidador numero <%d>\n", numPreval);
  }
#endif
#ifdef __DEBUG_1
  fprintf(fptr1,"AMX-07-00087-0A [LlamaCAAAREM] Prevalidador[%d] HOST[%s] Puerto[%d]\n"
              ,numPreval,strDireccion,serv_tcp_caaarem);
  fflush(fptr1);
#endif
  fprintf(fptr1,"[LlamaCAAAREM] Prevalidador a validar <%d> <%d> <%s>\n"
               ,numPreval,serv_tcp_caaarem,strDireccion);

  if ( (hptr = gethostbyname(strDireccion)) == NULL)
    {
#ifdef __AMX_07_00087_0A_1
      iIndAlterno=1;
      fprintf(fptr1,"[LlamaCAAAREM] Error 2: No se puede obtener la direccion del gethostbyname(%s) Puerto[%d] Alterno=%d\n"
	               ,strDireccion,serv_tcp_caaarem,iIndAlterno);
	  fflush(fptr1);
  	  renombrarArchivoS(EnviaTrama20,fptr1);
	  return 1;
#else
      ErrorNoFatal("BanCAAAREM: No se puede obtener la direccion del host SERV_HOST_CAAAREM");
#endif
    }
  else
    {
      pptr = hptr->h_addr_list;
      ptr = inet_ntop(AF_INET, *hptr->h_addr_list, str, sizeof(str));

      serv_addr_CAAAREM.sin_family = AF_INET;
      serv_addr_CAAAREM.sin_addr.s_addr = inet_addr(ptr);
    /**  serv_addr_CAAAREM.sin_addr.s_addr = (in_addr_t)*pptr; **/
      serv_addr_CAAAREM.sin_port = htons(serv_tcp_caaarem);
    }

  if ((sockfd_CAAAREM = socket(AF_INET, SOCK_STREAM, 0)) < 0)
  {
#ifdef __AMX_07_00087_0A_1
      iIndAlterno=1;
      fprintf(fptr1,"[LlamaCAAAREM] Error 3: No se puede abrir el socket stream HOST[%s] Puerto[%d] Alterno=%d\n"
	               ,strDireccion,serv_tcp_caaarem,iIndAlterno);
	  fflush(fptr1);
	  renombrarArchivoS(EnviaTrama20,fptr1);
	  return 1;
#else
      ErrorNoFatal("BanCAAAREM: No se puede abrir el socket stream sockfd_CAAAREM");
#endif
  }

  if (connect(sockfd_CAAAREM, (struct sockaddr *) &serv_addr_CAAAREM, sizeof(serv_addr_CAAAREM)) < 0)
  {
#ifdef __AMX_07_00087_0A_1
      iIndAlterno=1;
      fprintf(fptr1,"[LlamaCAAAREM] Error 4: No se puede hacer connect HOST[%s] Puerto[%d] Alterno=%d\n"
	               ,strDireccion,serv_tcp_caaarem,iIndAlterno);
	  fflush(fptr1);
	  renombrarArchivoS(EnviaTrama20,fptr1);
	  close(sockfd_CAAAREM);
	  return 1;
#else
     fprintf(fptr1,"BanCAAAREM: No se puede hacer connect al host desde sockfd_CAAAREM Prevalidador=%d Puerto=%d-%d HOST[%s]\n"
               ,numPreval,serv_addr_CAAAREM.sin_port,serv_tcp_caaarem,strDireccion);
     ErrorNoFatal("BanCAAAREM: No se puede hacer connect al host desde sockfd_CAAAREM \n");
#endif
  }

 /** write_data(sockfd_CAAAREM, EnviaTrama20);  **/

#ifdef __AMX_07_00087_0A_1
      if ( (result=write (sockfd_CAAAREM, EnviaTrama20, 20)) < 0 )
      {
        iIndAlterno=1;
        fprintf(fptr1,"[LlamaCAAAREM] Error 5: No se escribio el nombre del archivo[%s] -write- HOST[%s] Puerto[%d] Alterno=%d result=%d\n"
	                 ,EnviaTrama20,strDireccion,serv_tcp_caaarem,iIndAlterno,result);
        fflush(fptr1);
	    renombrarArchivoS(EnviaTrama20,fptr1);
		close(sockfd_CAAAREM);
	    return 1;
      }
#else
      write (sockfd_CAAAREM, EnviaTrama20, 20);
#endif
  LeeCabecera(EnviaTrama20, olEsNoPedimento, charEnviosI);
  EnviosI = atoi(charEnviosI);
#ifdef __DEBUG_1
  fprintf(fptr1,"1.EnviosI=%d\n",EnviosI);
  fflush(fptr1);
#endif
  sprintf(nombreArchivo, "%s", EnviaTrama20);
#ifdef __DEBUG_1
  fprintf(fptr1,"2.LetraArchivo(%s)\n",nombreArchivo);
  fflush(fptr1);
#endif

  if (LetraArchivo(nombreArchivo, olEsNoPedimento) == 0)
  {
   if (!olEsNoPedimento)
    nombreArchivo[0] = 'a';
   else
    nombreArchivo[0] = 'j';
  }
  else 
  {
	  if(!olEsNoPedimento)
    nombreArchivo[0] = 'A';
   else
    nombreArchivo[0] = 'J';
  }
  nombreArchivo[12] = '\0';

  fprintf(fptr1,"Archivo a enviar <%s>\n", nombreArchivo);
  EnviaTramanl = TamArchivo(nombreArchivo);
#ifdef __DEBUG_1
  fprintf(fptr1,"3.%d=TamArchivo(%s)\n",EnviaTramanl,nombreArchivo);
  fflush(fptr1);
#endif
  EnviaTramanlhtonl = htonl(EnviaTramanl);
  fprintf(fptr1,"\n Entero a enviar <%d> \n", EnviaTramanl);
#ifdef __AMX_07_00087_0A_1
  if ( !EnviaTramanl )
  {
    iIndAlterno=1;
    fprintf(fptr1,"[LlamaCAAAREM] Error 6: Falla Tamanio %d del Archivo[%s] -TamArchivo- HOST[%s] Puerto[%d] Alterno=%d result=%d\n"
	             ,EnviaTramanl,EnviaTrama20,strDireccion,serv_tcp_caaarem,iIndAlterno,result);
    fflush(fptr1);
	renombrarArchivoS(EnviaTrama20,fptr1);
	close(sockfd_CAAAREM);
	return 1;
  }
#endif

  fprintf(fptr1,"\n sizeof EnviaTramanlhtonl <%d>  RED <%ld>", EnviaTramanl, sizeof(EnviaTramanlhtonl));

#ifdef __AMX_07_00087_0A_1
  if ( (result = write(sockfd_CAAAREM, &EnviaTramanlhtonl, sizeof(EnviaTramanlhtonl))) < 0)
  {
    iIndAlterno=1;
    fprintf(fptr1,"[LlamaCAAAREM] Error 7: Archivo[%s] No se escribio la longitud del pedimento -write- HOST[%s] Puerto[%d] Alterno=%d result=%d\n"
	             ,EnviaTrama20,strDireccion,serv_tcp_caaarem,iIndAlterno,result);
    fflush(fptr1);
	renombrarArchivoS(EnviaTrama20,fptr1);
	close(sockfd_CAAAREM);
	return 1;
  }
#else
  result = write(sockfd_CAAAREM, &EnviaTramanlhtonl, sizeof(EnviaTramanlhtonl));
/**
  result = write(sockfd_CAAAREM, &resultado, sizeof(resultado));
**/
  if (result < 0)
    fprintf(fptr1, "\n No se escribio la longitud del pedimento: <%d> \n", result);
#endif

  fprintf(fptr1, "\n El result es: <%d> \n", result);
  fprintf(fptr1, "\n Network long: <%d> \n", EnviaTramanlhtonl);

  fflush(fptr1);
#ifdef __AMX_07_00087_0A_1
  if ( (result = read(sockfd_CAAAREM, &nacuse1, sizeof(nacuse1))) == -1)
  {
    iIndAlterno=1;
    fprintf(fptr1,"[LlamaCAAAREM] Error 8: Al leer el primer acuse -read- Archivo[%s] HOST[%s] Puerto[%d] Alterno=%d result=%d\n"
	             ,EnviaTrama20,strDireccion,serv_tcp_caaarem,iIndAlterno,result);
    fflush(fptr1);
	renombrarArchivoS(EnviaTrama20,fptr1);
	close(sockfd_CAAAREM);
	return 1;
  }
#else
  /**  read_data(sockfd_CAAAREM, RecibeTrama, MAXLINE, leidos_CAAAREM);  **/
  if ((result = read(sockfd_CAAAREM, &nacuse1, sizeof(nacuse1))) == -1)
         fprintf(fptr1,"Error al leer el primer acuse\n");
  else
    {
    /**     hacuse1 = ntohl(nacuse1); **/
    }
#endif
    fprintf(fptr1,"\n Acuse cabecera y long net <%d> \n", nacuse1);
    fprintf(fptr1,"[LlamaCAAAREM]: nacuse1[%d]", nacuse1);
    if (nacuse1 == 0)
    {
          fprintf(fptr1,"\n EnviArchivo: <%s>\n", EnviArchivo );
          /**       write_data(sockfd_CAAAREM, EnviArchivo);      se debe hacer en paqs. de 1024 ???  **/

     /**     strncpy(cadenaEnvio, EnviArchivo, EnviaTramanl);  **/
     /**     sprintf(EnviArchivo,"%s\r\n\xD", EnviArchivo);  **/
		  ptrbloque = (char *)malloc(EnviaTramanl + 1);
		  memset(ptrbloque,'\0',EnviaTramanl + 1);
		  sprintf(ptrbloque,"%s", EnviArchivo);
          ptrbloque[strlen(ptrbloque)] = '\0';
#ifdef __DEBUG_1
          fprintf(fptr1,"4.ptrbloque[%s]\n",ptrbloque);
          fflush(fptr1);
#endif
	/**  cadenaEnvio[EnviaTramanl+2] = '\0';  **/

		  fprintf(fptr1,"[LlamaCAAAREM] EnviaTrama20 <%s>", EnviaTrama20);
		  LeeCabecera(EnviaTrama20, olEsNoPedimento, charEnviosI);
		  EnviosI = atoi(charEnviosI);
#ifdef __DEBUG_1
  fprintf(fptr1,"5.EnviosI=%d\n",EnviosI);
  fflush(fptr1);
#endif
		  fprintf(fptr1,"[LlamaCAAAREM]: EnviArchivo <%s> a enviar <%d>", ptrbloque, EnviosI);
		  fprintf(fptr1,"[LlamaCAAAREM]: EnviArchivo <%s>", EnviArchivo);

		  /**  write(sockfd_CAAAREM, EnviArchivo, EnviaTramanl + 1);  **/
		  fprintf(fptr1,"[LlamaCAAAREM] Caracteres a enviar:%ld\n", (strlen(ptrbloque)));
		  fprintf(fptr1,"[LlamaCAAAREM] Bloque a enviar <%s>\n", ptrbloque);
#ifdef __AMX_07_00087_0A_1
  if ( (result = write(sockfd_CAAAREM, ptrbloque, (strlen(ptrbloque)))) < 0)
  {
    iIndAlterno=1;
    fprintf(fptr1,"[LlamaCAAAREM] Error 9: No se pudo enviar el Archivo[%s] -write- HOST[%s] Puerto[%d] Alterno=%d result=%d\n"
	             ,EnviaTrama20,strDireccion,serv_tcp_caaarem,iIndAlterno,result);
    fflush(fptr1);
	renombrarArchivoS(EnviaTrama20,fptr1);
	close(sockfd_CAAAREM);
	return 1;
  }
#else
		  result = write(sockfd_CAAAREM, ptrbloque, (strlen(ptrbloque)));  /**EnviaTramanl + 1);  **/
		  if (result <= 0)
		  {
			  fprintf(fptr1,"\n No se pudo enviar el archivo <%s>"
					 "\n Entra a la carpeta de contingencia\n", EnviaTrama20);
		  }
#endif



		  shutdown(sockfd_CAAAREM, SHUT_WR);
#ifdef __AMX_07_00087_0A_1
  if ( (result = read(sockfd_CAAAREM, (int *) &nacuse2, sizeof(nacuse2))) == -1)
  {
    iIndAlterno=1;
    fprintf(fptr1,"[LlamaCAAAREM] Error 10: Al leer el segundo acuse Archivo[%s] -read- HOST[%s] Puerto[%d] Alterno=%d result=%d\n"
	             ,EnviaTrama20,strDireccion,serv_tcp_caaarem,iIndAlterno,result);
    fflush(fptr1);
	renombrarArchivoS(EnviaTrama20,fptr1);
	close(sockfd_CAAAREM);
	return 1;
  }
#else
		  if ((result = read(sockfd_CAAAREM, (int *) &nacuse2, sizeof(nacuse2))) == -1)
			 fprintf(fptr1,"Error al leer el segundo acuse\n");
		  else
		  {

				hacuse2 = ntohl(nacuse2);
		  }
#endif


		  if(numPreval != 4)
		  {

		/** Inicia conversion */
		  sprintf(xnumero, "%08X", nacuse2);
		  xnumero[8] = '\0';

		  fprintf(fptr1,"EL NUMERO %d CONVERTIDO EN HEXADECIMAL ES %s\n", nacuse2, xnumero);

		  strncpy(byte1, xnumero, 2);
		  byte1[2] = '\0';
		  fprintf(fptr1,"BYTE1[%s]\n", byte1);

		  strncpy(byte2, xnumero +2, 2);
		  byte2[2] = '\0';
		  fprintf(fptr1,"BYTE2[%s]\n", byte2);

		  strncpy(byte3, xnumero + 4, 2);
		  byte3[2] = '\0';
		  fprintf(fptr1,"BYTE3[%s]\n", byte3);

		  strncpy(byte4, xnumero  + 6 , 2);
		  byte4[2] = '\0';
		  fprintf(fptr1,"BYTE4[%s]\n", byte4);

		  sprintf(xinvertido, "%s%s%s%s", byte4, byte3, byte2, byte1);
		  xinvertido[8] = '\0';
#ifdef __DEBUG_1
          fprintf(fptr1,"6.xinvertido[%s]\n",xinvertido);
          fflush(fptr1);
#endif
		  hacuse2 = Convert(xinvertido, 16);
#ifdef __DEBUG_1
		  fprintf(fptr1,"7.%d=Convert(%s, 16)\n",hacuse2,xinvertido);
          fflush(fptr1);
#endif
		  }

		  fprintf(fptr1,"SE RECIBE FORMATO RED <%d> CONVERTIDO A ENTERO <%d>\n", nacuse2, hacuse2);
		/**  Termina Conversion  **/
			   fprintf(fptr1,"\n Acuse Archivo net <%d> \n", nacuse2);

			   fprintf(fptr1, "\n Acuse Archivo host <%d> \n", hacuse2);

			   fflush(fptr1);

			   if (hacuse2 == 0)
			   {
#ifdef __AMX_07_00087_0A_1
				    iIndAlterno=0;
#endif
					fprintf(fptr1,"\n BanCAAAREM: Cabecera y Archivo aceptados.  \n");
			   }
			   else
			   {
					fprintf(fptr1,"\n BanCAAAREM: Archivo Rechazado. %d \n", hacuse2);
			   }
		  }
		  else
		  {
			   fprintf(fptr1,"\n BanCAAAREM: Cabecera Rechazada. Archivo no enviado. %d \n", hacuse1);
		  }

    fflush(fptr1);

/**    shutdown(sockfd_CAAAREM, SHUT_WR);  **/
    close(sockfd_CAAAREM);

    if (leidos_CAAAREM)
       free(leidos_CAAAREM);
	if (charEnviosI)
		free(charEnviosI);
	if (varborradachar)
		free(varborradachar);
	if (ptrbloque)
		free(ptrbloque);
#ifdef __AMX_07_00087_0A_1
	if(iIndAlterno)
	{
      fprintf(fptr1,"[LlamaCAAAREM] Error 11: Archivo[%s]  HOST[%s] Puerto[%d] Alterno=%d result=%d\n"
	             ,EnviaTrama20,strDireccion,serv_tcp_caaarem,iIndAlterno,result);
      fflush(fptr1);
	  renombrarArchivoS(EnviaTrama20,fptr1);
	}
    return iIndAlterno;
#else
	return 0;
#endif
}
